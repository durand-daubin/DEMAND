---
title: 'The Changing Timing of Cooking in the United Kingdom and France: Implications
  for Energy Demand'
author: "Mathieu Durand-Daubin, Ben Anderson (mathieu.durand-daubin@edf.fr; b.anderson@soton.ac.uk)"
date: 'Last run at: `r Sys.time()`'
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  md_document:
    fig_caption: yes
    number_sections: yes
    theme: journal
    toc: yes
    toc_depth: 3
  html_document:
    fig_caption: yes
    number_sections: yes
    self_contained: no
    theme: journal
    toc: yes
  word_document:
    fig_caption: yes
    number_sections: yes
    theme: journal
    toc: yes
bibliography: bibliography.bib
---

```{r setupKnitr, include=FALSE}
# set default echo to FALSE (code not in output)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig_caption = TRUE)
knitr::opts_chunk$set(tidy = TRUE)
```

\pagebreak

Abstract (original)

Aggregate energy demand follows strong repetitive patterns on multiple scales (day, week, seasons), due to social rhythms coordinating the synchronicity of consuming practices. These patterns are not only related to natural cycles that remain unchanged, but also to social structures and technology, that change over the years and across different geographical areas.
How do these changes and regional differences affect energy demand rhythms? Answering this question, would improve our understanding of demand flexibility and possible future evolutions.

In this research we study the energy footprint of practices which are widely shared, highly regular, and key markers of the social organisation: eating practices. Different types of meals and food preparation are described based on the quantitative data collected by the means of Time Use Surveys in France and in the United Kingdom. These practices are defined in terms of time, durations, primary, secondary and surrounding activities, participants, and places. The distribution of these practices are studied across several time scales (week days, seasons, and decades from 1974 to 2010) and areas (UK, France and French regions). The temporal and spatial variations of eating practices can then be compared with the energy demand measured by the power grids or in specific campaigns, and varying along the same axes. This comparison reveals how parts of the energy demand dynamic are related to specific practices and their synchronisation. Finally, the mechanism of this coevolution can be partly interpreted in the light of wider social and technical changes depicted in socio-economic and demographic series (employment structure, food consumption, home equipment).

\pagebreak

````{r houseKeeping}
print("# Setting up R environment")
# Clear out all old objects etc ----
# to avoid confusion
rm(list = ls()) 

# Set time ----
starttime <- Sys.time()

# Load required packages ----
packs <- c("ggplot2", # slick & easy graphs
       "data.table", # fast data manipulation
       "knitr", # for kable
       "survey" # weighted survey analysis
       )

# do this to install them if needed
# install.packages(x)
print("Loading required packages:")
print(packs)

# NB - this returns 'FALSE' if a package fails but the script continues - can lead to problems further on if functions are called which cannot be found
lapply(packs, require, character.only = T)

# Set paths ----
mtusPath <- "~/Data/MTUS/World_6/processed/"

# Set file names ----
surveyFile <- "MTUSW6UKsurveyCore_DT.csv.gz"
episodesFile <- "MTUSW6UKdiaryEps_DT.csv.gz"

sfile <- paste0(mtusPath, surveyFile)
efile <- paste0(mtusPath, episodesFile)
````

\pagebreak

# Introduction
Discussion of temporal nature of electricity demand, interest in peaks (reasons for this) and the ability to shift in general.

Recent work (DECC HES?) has highlighted the role of cooking (and subequently eating) in generating demand for electricity during the evening peak period (give times).

At the same time recent work (Southerton et al) has shown how the habits and practices of eating have changed over time in the UK anbd Spain. Although this work only provides an analysis of the duration of acts (episodes) it provides evidence of the ongoing evolution of eating habits which may have implications for cooking and thus for electricity/energy demand.

It is possible that 're-arranging' cooking habits may be one way to reduce the problematic evening peak electricity demand. However without a more detailed analysis of what kinds of eating (and especially cooking) are already changing and of the variation in cooking practices across the population, we have little idea where to start.

Digression on time use as a footprint/proxy for practices?

This paper uses nationally representative time use diary data form the United Kingdom and France to compare and contrast the changing timing of cooking and eating in each country over the last 30 years. It then uses the most recent data to analyse and comapre the social and spatial variation in current eating practices in each country. Finally the paper provides preliminary analysis of French regional residential electricity consumption data which highlights the role of regional variation in cooking practices. The paper concludes with a discussion of the implications of the results for electricity demand in the UK and France and outlines directions for future research

# Cooking, Eating and Energy
Here we need to talk about the changing nature of cooking & eating from the literature (if there is any) - quant (e.g. Southerton) & qual (e.g. Warde).

Need then to link it to energy consumption - in UK gas & electricity used for cooking, in France = electricity (mostly, but LPG?).

More detailed discussion of the problem of peak demand? - expensive/dirty generation?

 * energy implication of different preparations : cooking/not cooking, in different places, with different appliances
 * giving time : synchronising a number of other energy demanding practices -> peaks
	
 We then need to explain here how we come to discuss these meal types:

 * weekday lunch 
 * weekday dinner
 * sunday lunch
 
Should this come after a general exploration of the data? So that we can look at the timings and then explain why we concentrate on these 'practices'?

# Data and Methods
A relatively brief introduction to the time use diary data for each country:

 * years & sources
 * key collection/diary features
 * categories of activities & any coding issues/missing attributes

Discussion of stats tools used. For UK, R and in particular:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * ggplot2 - for slick grpahics [@ggplot2]
 * survey - for weighted survey analysis [@survey]
 * knitr - to create this document [@knitr]
 
## United Kingdom (MTUS)

```{r loadUkEpisodes}
# use gunzip method
ecmd <- paste0("gunzip -c ", efile)
mtusUKEpisodes_DT <- fread(ecmd)
# set key 
setkey(mtusUKEpisodes_DT, ba_diarypid)
```

```{r processUkEpisodes}
# Episodes processing ----

# > XX need to fix: ----
# >> text glich restaurant, caf\xe9, bar, pub ----

# > drop 1995 ----
mtusUKEpisodes_DT <- subset(mtusUKEpisodes_DT, survey != 1995)

# > order r_dow correctly ----
mtusUKEpisodes_DT[, r_dow := factor(r_dow, 
				levels = c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")
				)
		]
		
# > Create a simpler location ----
mtusUKEpisodes_DT[, ba_eloc := ifelse(eloc == "at own home",
	"Home",
	NA
	)
	]
mtusUKEpisodes_DT[, ba_eloc := ifelse(eloc == "at another\342\200\231s home",
	"Family/friends",
	ba_eloc
	)
	]
mtusUKEpisodes_DT[, ba_eloc := ifelse(eloc == "at school" | eloc == "at workplace",
	"Work or school",
	ba_eloc
	)
	]
mtusUKEpisodes_DT[, ba_eloc := ifelse(eloc == "at place of worship" | eloc == "at restaurant, bar etc" | 
	eloc == "at services or shops" | eloc == "travelling" | eloc == "other locations",
	"Out (somewhere)",
	ba_eloc
	)
	]
mtusUKEpisodes_DT[, ba_eloc := ifelse(eloc == "location unknown",
	"Unknown",
	ba_eloc
	)
	]

# > create a weekday/weekend factor ----
mtusUKEpisodes_DT[, ba_weekday := ifelse(r_dow == "Saturday",
						"Saturday",
						r_dow
					)
		]
		
mtusUKEpisodes_DT[, ba_weekday := ifelse(r_dow == "Sunday",
				"Sunday",
				ba_weekday
			)
]
mtusUKEpisodes_DT[, ba_weekday := ifelse(r_dow != "Saturday" & r_dow != "Sunday",
				"Weekday",
				ba_weekday
			)
]
# check
with(mtusUKEpisodes_DT,
	table(r_dow, ba_weekday)
	)
	
# > add month ----
# there will be a few NAs
mtusUKEpisodes_DT[, r_month := as.POSIXlt(mtusUKEpisodes_DT$r_date)$mon] # 0 = January

# > add season ----
mtusUKEpisodes_DT[, season := ifelse(mtusUKEpisodes_DT$r_month > 1 & mtusUKEpisodes_DT$r_month < 5,
                                    "Spring", 
                                    NA
                                    )
                  ]

mtusUKEpisodes_DT[, season := ifelse(mtusUKEpisodes_DT$r_month > 4 & mtusUKEpisodes_DT$r_month < 8,
                                    "Summer", 
                                    mtusUKEpisodes_DT$season
                                    )
                  ]

mtusUKEpisodes_DT[, season := ifelse(mtusUKEpisodes_DT$r_month > 7 & mtusUKEpisodes_DT$r_month < 11,
                                    "Autumn", 
                                    mtusUKEpisodes_DT$season
                                    )
                  ]

mtusUKEpisodes_DT[, season := ifelse(mtusUKEpisodes_DT$r_month == 11 | 
                                      mtusUKEpisodes_DT$r_month == 0 | 
                                      mtusUKEpisodes_DT$r_month == 1 ,
                                    "Winter", 
                                    mtusUKEpisodes_DT$season
                                    )
                  ]
                  

# set month to factor after we have created the season
mtusUKEpisodes_DT[, r_month := factor(mtusUKEpisodes_DT$r_month,
                     labels = c(
                       "January", # 0
                       "February",
                       "March",
                       "April",
                       "May",
                       "June",
                       "July",
                       "August",
                       "September",
                       "October",
                       "November",
                       "December" # 11 !
                       )
                     )
                  ]

# check
#table(mtusUKEpisodes_DT$r_month, mtusUKEpisodes_DT$season, useNA = "always")

# > Cooking/food prep = 18 but imported here as text ----
cook <- "food preparation, cooking"
# main act
mtusUKEpisodes_DT[, is_cooking_m:= ifelse(main == cook, 
                                          1, # cooking
                                          0 # not cooking
                                          )
                  ]
# secondary act
mtusUKEpisodes_DT[, is_cooking_s:= ifelse(sec == cook, 
                                          1, # cooking
                                          0 # not cooking
                                          )
                  ]
# main or secondary
mtusUKEpisodes_DT[, is_cooking_all:= ifelse(is_cooking_m == 1 | is_cooking_s == 1, 
                                          1, # cooking
                                          0 # not cooking
                                          )
                  ]

# > Eating = 5 or 6 but imported here as text ----
eat_wk <- "meals at work or school"
eat_oth <- "meals or snacks in other places"
mtusUKEpisodes_DT[, is_eating_m:= ifelse(main == eat_wk | main == eat_oth, 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]
# >> eat @ home ----
mtusUKEpisodes_DT[, is_eating_mHome:= ifelse(is_eating_m == 1 & ba_eloc == "Home", 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]
# >> eat @ family/friends ----
mtusUKEpisodes_DT[, is_eating_mFf:= ifelse(is_eating_m == 1 & ba_eloc == "Family/friends", 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]
# >> eat @ work/school ----
mtusUKEpisodes_DT[, is_eating_mWs:= ifelse(is_eating_m == 1 & ba_eloc == "Work or school", 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]
# >> eat out ----
mtusUKEpisodes_DT[, is_eating_mOut:= ifelse(is_eating_m == 1 & ba_eloc == "Out (somewhere)", 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]

# secondary act
mtusUKEpisodes_DT[, is_eating_s:= ifelse(sec == eat_wk | sec == eat_oth, 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]
# main or secondary
mtusUKEpisodes_DT[, is_eating_all:= ifelse(is_eating_m == 1 | is_eating_s == 1, 
                                          1, # eating
                                          0 # not eating
                                          )
                  ]

# Create the specific eating practices

# > createWeekdayLunch ----
# Need to create an hour variable from r_epStartTime to avoid losing all those  not set in r_epStartDateTime
mtusUKEpisodes_DT[, hour := as.POSIXlt(r_epStartTime)$hour]
mtusUKEpisodes_DT[, mins := as.POSIXlt(r_epStartTime)$min]


mtusUKEpisodes_DT[, weekdayLunch := ifelse(is_eating_m == 1 & hour >= 12 & hour <= 14 & 
                                             r_dow != "Saturday" & r_dow != "Sunday",
                                                      1, # is weekday lunch
                                                      0 # is not
                                                      )
                             ]

# check - should be weekdays only
#table(mtusUKEpisodes_DT$weekdayLunch,
#      mtusUKEpisodes_DT$r_dow,
#      useNA = "always"
#      )


# > createDinner ----
# flag dinner
mtusUKEpisodes_DT[, dinner := ifelse(is_eating_m == 1 & hour >= 17 & hour < 22,
                                                      1, # is dinner
                                                      0 # is not
                                                      )
                             ]
# check - should only be in the evening
#table(mtusUKEpisodes_DT$hour,
#      mtusUKEpisodes_DT$dinner,
#      useNA = "always")


# > createSundayLunch ----
# flag sunday lunch
mtusUKEpisodes_DT[, sundayLunch := ifelse(is_eating_m == 1 & hour >= 12 & hour <= 15 &
                                            r_dow == "Sunday",
                                          1, # is sunday lunch
                                          0 # is not
                                          )
                             ]
# check (should only be on Sunday)
#table(mtusUKEpisodes_DT$sundayLunch,
#      mtusUKEpisodes_DT$r_dow,
#      useNA = "always"
#      )

# > Create the halfhour indicator table ----
# Uses the processed episodes to aggregate
mtusUKHalfhourIndicator_DT <- mtusUKEpisodes_DT[,
                    .(
                      n_main_cook_eps = sum(is_cooking_m),
                      n_main_eat_eps = sum(is_eating_m),
                      n_is_eating_mHome_eps = sum(is_eating_mHome),
                      n_is_eating_mFf_eps = sum(is_eating_mFf),
                      n_is_eating_mWs_eps = sum(is_eating_mWs),
                      n_is_eating_mOut_eps = sum(is_eating_mOut)
                    ),
                    by = .(survey, ba_survey, season, ba_diarypid, ba_eloc, r_dow, ba_weekday, mtrav, st_halfhour)
                    ]
mtusUKHalfhourIndicator_DT[, any_cook_m := ifelse(n_main_cook_eps > 0,
                           1, # at least 1 episode of cooking
                           0)
]
mtusUKHalfhourIndicator_DT[, any_eat_m := ifelse(n_main_eat_eps > 0,
                           1, # at least 1 episode of eating
                           0)
]
mtusUKHalfhourIndicator_DT[, any_is_eating_mHome_eps := ifelse(n_is_eating_mHome_eps > 0,
                           1, # at least 1 episode of eating
                           0)
]
mtusUKHalfhourIndicator_DT[, any_is_eating_mFf_eps := ifelse(n_is_eating_mFf_eps > 0,
                           1, # at least 1 episode of eating
                           0)
]
mtusUKHalfhourIndicator_DT[, any_is_eating_mWs_eps := ifelse(n_is_eating_mWs_eps > 0,
                           1, # at least 1 episode of eating
                           0)
]
mtusUKHalfhourIndicator_DT[, any_is_eating_mOut_eps := ifelse(n_is_eating_mOut_eps > 0,
                           1, # at least 1 episode of eating
                           0)
]
```

```{r loadUkSurveys}
# Load survey ----
scmd <- paste0("gunzip -c ", sfile)
mtusUKSurvey_DT <- fread(scmd)
setkey(mtusUKSurvey_DT, ba_diarypid)
```

```{r processUkSurveys}
# > drop 1995 ----
mtusUKSurvey_DT <- subset(mtusUKSurvey_DT, survey != 1995)

# > Create unique survey cases table ----
# Most survey have  more than 1 diary day...
setkey(mtusUKSurvey_DT, ba_pid)
mtusUKSurveyUniq_DT <- unique(mtusUKSurvey_DT)

# check
#table(mtusUKSurveyUniq_DT$survey)

# > Create a survey version  ----
# tell survey that the diarypids are the ids (they repeat)
svyMtusUKSurveyUniq_DT <- svydesign(ids = ~ba_pid, 
                                    weight = ~propwt, 
                                    data = mtusUKSurveyUniq_DT
)
```

```{r mergeUkData}
# Merge the survey to the processed episodes ----
setkey(mtusUKEpisodes_DT, ba_diarypid)
setkey(mtusUKSurvey_DT, ba_diarypid)
mtusUKEpisodes_DTj <- merge(mtusUKEpisodes_DT, mtusUKSurvey_DT)

# > create a survey version of joined episodes ----
# tell survey that the diarypids are the ids (they repeat)
svyMtusUKEpisodes_DTj <- svydesign(ids = ~ba_diarypid, 
                                  weight = ~propwt, 
                                  data = mtusUKEpisodes_DTj
)



# Join the survey to the half hour indicator tables ----
setkey(mtusUKHalfhourIndicator_DT, ba_diarypid)
setkey(mtusUKSurvey_DT, ba_diarypid)
mtusUKHalfhourIndicator_DTj <- merge(mtusUKHalfhourIndicator_DT, mtusUKSurvey_DT)

# > create a survey version of joined halfhour indicator table ----
# tell survey that the diarypids are the ids (they repeat)
svyMtusUKHalfhourIndicator_DTj <- svydesign(ids = ~ba_diarypid, 
                                  weight = ~propwt, 
                                  data = mtusUKHalfhourIndicator_DTj
)
```

Key codes in the MTUS:

 * meals at work or school = 5 (not available in all surveys)
 * meals or snacks in other places = 6
 * food preparation, cooking = 18
 * restaurant, cafe, bar, pub = 39 (but may not be eating?!)
 * out with friends could be eating = 48 (but check location as might also be at home)
 * eloc = location
 
Mention pooling 1983/4 & 1987 to form one '12 month' survey ref MTUS userguide p13

Mention not using 1995 as it was only collected in May (and location poorly recorded

Report some basic (unweighted) descriptive statsitics of the sample we will use. 

```{r ukRespondentsByYearAge}
# need unique survey case
kable(caption="MTUS survey repondents by age range and survey (unweighted)",
  table(mtusUKSurveyUniq_DT$ba_age_r, mtusUKSurveyUniq_DT$ba_survey, useNA = "always")
)

```

```{r ukRespondentsByYearSex}
# need unique survey case
kable(caption="MTUS survey repondents by sex and survey (unweighted)",
  table(mtusUKSurveyUniq_DT$sex, mtusUKSurveyUniq_DT$ba_survey, useNA = "always")
)
```

Finally we are also interested in trends in the location of both cooking and eating as this may also have implications for the nature of energy demand. The following table reports the weighted count of episodes by location and shows extent to which location of episodes is known in the different surveys.

```{r weightedLocationEpisodesTable}

ftable(svytable(~ba_eloc + ba_survey.x, svyMtusUKEpisodes_DTj, round = TRUE))
 
```

Clearly we are unable to tell if the episode location was at family/friends in any year except 1985 and 2000 whilst a large number are unkown in 2005 when location was poorly coded. 

### Cooking and eating episodes

Both cooking and eating could have been reported as main and secondary acts in all surveys except 1995 when secondary activities were not collected. For cooking we can see from the table below that the reporting of cooking was roughly constant over time but as a secondary act was low (0.5 to 2 %) in most surveys. As it is never clear whether secondary activities are simply rare, under-reported or not completed due to respondent burden (XX reference XX) in the remainder of the chapter we will focus on cooking as a main activity only.

```{r weightedCookingEpisodesTable}
# how many weighted cooking episodes do we have?
main <- svyby(~is_cooking_m, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )
# fiddle to get the right look to the table
tm <- as.data.table(main)
tm[, is_cooking_m := round(is_cooking_m*100, 2)]
tm[, se := NULL] # drop SE as we're going to add the 95% CI

cm <- round(confint(main)*100,2)
tm <- as.data.table(cbind(tm,cm))
setnames(tm, c("Survey", "Main (% all episodes)", "2.5%", "97.5%"))

sec <- svyby(~is_cooking_s, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )
# fiddle to get the right look to the table
ts <- as.data.table(sec)
ts[, is_cooking_s := round(is_cooking_s*100, 2)]
ts[, se := NULL] # drop SE as we're going to add the 95% CI

cs <- round(confint(sec)*100,2)
ts <- as.data.table(cbind(ts,cs))

setnames(ts, c("Survey", "Secondary (% all episodes)", "2.5%", "97.5%"))
setkey(tm, Survey)
setkey(ts, Survey)
table <- tm[ts]
setnames(table, c("Survey", "Main (% all episodes)", "2.5%", "97.5%",
               "Secondary (% all episodes)", "2.5%", "97.5%"))

kable(caption = "Weighted proportion of episodes reported as cooking (with 95% CI)",
      table
      )
```

Similarly, the reporting of eating is also faily constant over time and was reported in between one and four percent of secondary activity episodes. As above, due to uncertainties over the intepretation of secondary activities we will focus on eating as a main activity only in the remainder of the chapter

```{r weightedEatingEpisodesTable}
# how many weighted cooking episodes do we have?
main <- svyby(~is_eating_m, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )
# fiddle to get the right look to the table
tm <- as.data.table(main)
tm[, is_eating_m := round(is_eating_m*100, 2)]
tm[, se := NULL] # drop SE as we're going to add the 95% CI

cm <- round(confint(main)*100,2)
tm <- as.data.table(cbind(tm,cm))
setnames(tm, c("Survey", "Main (% all episodes)", "2.5%", "97.5%"))

sec <- svyby(~is_eating_s, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )
# fiddle to get the right look to the table
ts <- as.data.table(sec)
ts[, is_eating_s := round(is_eating_s*100, 2)]
ts[, se := NULL] # drop SE as we're going to add the 95% CI

cs <- round(confint(sec)*100,2)
ts <- as.data.table(cbind(ts,cs))

setnames(ts, c("Survey", "Secondary (% all episodes)", "2.5%", "97.5%"))
setkey(tm, Survey)
setkey(ts, Survey)
table <- tm[ts]
setnames(table, c("Survey", "Main (% all episodes)", "2.5%", "97.5%",
               "Secondary (% all episodes)", "2.5%", "97.5%"))

kable(caption = "Weighted proportion of episodes reported as eating (with 95% CI)",
      table
      )
```

## France (MTUS)

 * 1986 - 5 minutes resolution
 * 1998 - 10 minutes resolution
 * 2010 - 10 minutes resolution

...

Brief discussion of how we code weekday lunch, weekday dinner and sunday lunch in the French data

# The changing temporality of cooking and eating in the UK and France

Here we use the MTUS (UK) and French data to look at change in cooking (& eating?) over the last 30 years through the lenses of the three meal type.

> Need to decide whether to use:
>  * % of episodes OR
>  * % of halfhours in which the activity was recorded at least once (= 'any in the  half hour' indicator) 
> I have tested the two approaches below and they seem to give similar results...?


## The distribution of cooking and eating as main activities

Having the established the overall distributions of eating and cooking and chosen to focus on these as main activities, the following table shows the weighted proportion of episodes which were reported as cooking as a main activity by men and women in each survey. In general women report a far higher percentage of episodes as cooking/food preparation than men although the ratio has equalised somewhat from 1:`r round(2.11/12.13,2)` in 1974 to 1:`r round(6.62/10.16,2)` by 2005.

```{r weightedCookingGender}
cookEpsWm <- svyby(~is_cooking_m, # the variable to calculate the stat for
                   ~sex + ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )

# fiddle to get the right look to the table
t <- as.data.table(cookEpsWm)
t[, is_cooking_m := round(is_cooking_m*100, 2)]
t[, se := NULL] # drop SE as we're going to add the 95% CI

c <- round(confint(cookEpsWm)*100,2)
t <- cbind(t,c)
setnames(t, c("Sex", "Survey", "% episodes", "2.5%", "97.5%"))

kable(caption = "UK: Weighted proportion of episodes reported as cooking as a main activity by men and women (with 95% CI)",
      t
      )
```

In comparison, eating is reported far more equally (see below) with both men and women consistently reporting eating as a main activity in between 11 and 14 percent of episodes.

```{r weightedEatingGender}
# how many weighted eating episodes do we have?
eatEpsWt <- svytable(~ba_survey.x + sex + is_eating_m, # the row * columns we want
                    svyMtusUKEpisodes_DTj # the data in survey form
)
eatEpsWm <- svyby(~is_eating_m, # the variable to calculate the stat for
                   ~sex + ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   svymean # the stat function
                   )
# fiddle to get the right look to the table
t <- as.data.table(eatEpsWm)
t[, is_eating_m := round(is_eating_m*100, 2)]
t[, se := NULL] # drop SE as we're going to add the 95% CI

c <- round(confint(eatEpsWm)*100, 2) 
t <- cbind(t,c)
setnames(t, c("Sex", "Survey", "% episodes", "2.5%", "97.5%"))

kable(caption = "UK: Weighted proportion of episodes reported as eating as a main activity by men and women (with 95% CI)",
      t
      )
```

However as the introduction to this chapter explained, the concern here is less with gender inequalities per se but more with the porentially changing temporal distronution of cooking and eating and the role that gendered norms may play. The following charts show the weighted distribution of cooking as a main activity across time of day and day of the week for the different surveys for all adults.

The first chart shows the results using the '% of episodes' recorded as cooking in each half hour whilst the second shows the results using the 'any in the  half hour' indicator. We do not see substantial differences.

```{r cookingByHalfhourEps}

epst <- svyby(~is_cooking_m, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x + ba_weekday, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   svymean # the stat function
                   )

ggplot(epst, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = is_cooking_m*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Cooking in the UK \n % of episodes per halfhour by Saturday/Sunday/weekday (mean)") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  #scale_color_discrete(hi = "green", lo = "black") +
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  facet_grid(ba_weekday ~ .) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

```{r cookingByHalfhourIndicator}

it <- svyby(~any_cook_m, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x + ba_weekday, # the factors
                   svyMtusUKHalfhourIndicator_DTj, # the data in survey form
                   svymean # the stat function
                   )

ggplot(it, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = any_cook_m*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Cooking in the UK \n % of any per halfhour by Saturday/Sunday/weekday (mean)") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  #scale_color_discrete(hi = "green", lo = "black") +
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  facet_grid(ba_weekday ~ .) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

The following charts show the distribution of eating across time of day and day of the week for the different surveys. Again the first chart shows the % of episodes recorded as eating whilst the second uses the 'any in the  half hour' indicator. Again we do not see substantial differences.

```{r eatingByHalfhourEps}

epst <- svyby(~is_eating_m, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x + ba_weekday, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   svymean # the stat function
                   )

ggplot(epst, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = is_eating_m*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Eating in the UK \n % of episodes per halfhour by Saturday/Sunday/weekday (mean)") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  #scale_color_discrete(hi = "green", lo = "black") +
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  facet_grid(ba_weekday ~ .) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

```{r eatingByHalfhourIndicator}

it <- svyby(~any_eat_m, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x + ba_weekday, # the factors
                   svyMtusUKHalfhourIndicator_DTj, # the data in survey form
                   svymean # the stat function
                   )

ggplot(it, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = any_eat_m*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Eating in the UK \n % of any per halfhour by Saturday/Sunday/weekday (mean)") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  #scale_color_discrete(hi = "green", lo = "black") +
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  facet_grid(ba_weekday ~ .) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

> XX The % episodes & 'any in the  half hour' indicator patterns look similar - shall we stick with the % of episodes? See also further comparisons in the Annex Section 8.2 XX

XX Brief discussion of our consequential interest in patterns of weekday lunch, weekday dinner and sunday lunch and discussion of how we code them in the MTUS: XX

 * Weekday lunch is coded as eating between 12:00 and 14:00 at any location on a week day
 * Dinner is coded as any eating 17:00 - 22:00
 * Sunday lunch is coded as any eating between 12:00 and 15:00 on Sundays


The following tables summarise the prevalence of these 'eating practices' in the different UK surveys.

```{r weekdayLunchSummary}
# weekday lunch ----
weekdayLunchWm <- svyby(~weekdayLunch, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )

# fiddle to get the right look to the table
t <- as.data.table(weekdayLunchWm)
t[, weekdayLunch := round(weekdayLunch*100, 2)]
t[, se := NULL] # drop SE as we're going to add the 95% CI

c <- round(confint(weekdayLunchWm)*100, 2)
t <- cbind(t,c)
setnames(t, c("Survey", "% episodes", "2.5%", "97.5%"))

kable(caption = "UK: Weighted proportion of episodes coded as weekday lunch as a main activity",
      t
      )
```


```{r dinnerSummary}
# dinner
dinnerWm <- svyby(~dinner, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )

# fiddle to get the right look to the table
t <- as.data.table(dinnerWm)
t[, dinner := round(dinner*100, 2)]
t[, se := NULL] # drop SE as we're going to add the 95% CI

c <- round(confint(dinnerWm)*100, 2)
t <- cbind(t,c)
setnames(t, c("Survey", "% episodes", "2.5%", "97.5%"))

kable(caption = "UK: Weighted proportion of episodes coded as dinner as a main activity",
      t
      )
```


```{r sundayLunchSummary}
# dinner
sundayLunchWm <- svyby(~sundayLunch, # the variable to calculate the stat for
                   ~ba_survey.x, # the factors
                   svyMtusUKEpisodes_DTj, # the data in survey form
                   #svyciprop, method = "logit"
                   svymean # the stat function
                   )

# fiddle to get the right look to the table
t <- as.data.table(sundayLunchWm)
t[, sundayLunch := round(sundayLunch*100, 2)]
t[, se := NULL] # drop SE as we're going to add the 95% CI

c <- round(confint(sundayLunchWm)*100, 2) 
t <- cbind(t,c)
setnames(t, c("Survey", "% episodes", "2.5%", "97.5%"))
kable(caption = "UK: Weighted proportion of episodes coded as sunday lunch as a main activity",       
	t       
) 
``` 


## Week-day eating
		- Contemporary : timing, location, participants, seasons, who cooks (content can change depending on the relevance for this type of meal)
		- What changed in history -> energy implications
		- What varies between regions -> energy implications

```{r weekdayEatingAtHome}
# at home
st <- svyby(~is_eating_mHome, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x, # the factors
                   subset(svyMtusUKEpisodes_DTj, ba_weekday == "Weekday"), # the data in survey form
                   svymean # the stat function
                   )

ggplot(st, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = is_eating_mHome*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Eating at home in the UK \n % of episodes per halfhour on weekdays") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

```{r weekdayEatingAtFf}
# at home
st <- svyby(~is_eating_mFf, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x, # the factors
                   subset(svyMtusUKEpisodes_DTj, ba_weekday == "Weekday"), # the data in survey form
                   svymean # the stat function
                   )

ggplot(st, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = is_eating_mFf*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Eating at friends/family in the UK \n % of episodes per halfhour on weekdays") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

```{r weekdayEatingAtWs}
# at home
st <- svyby(~is_eating_mWs, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x, # the factors
                   subset(svyMtusUKEpisodes_DTj, ba_weekday == "Weekday"), # the data in survey form
                   svymean # the stat function
                   )

ggplot(st, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = is_eating_mWs*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Eating at work/school in the UK \n % of episodes per halfhour on weekdays") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

```{r weekdayEatingOut}
# at home
st <- svyby(~is_eating_mOut, # the variable to calculate the stat for
                   ~st_halfhour + ba_survey.x, # the factors
                   subset(svyMtusUKEpisodes_DTj, ba_weekday == "Weekday"), # the data in survey form
                   svymean # the stat function
                   )

ggplot(st, aes(x = as.POSIXct(st_halfhour, 
                               format = "%H:%M", 
                               tz="UTC"),
                            y = is_eating_mOut*100,
               colour = as.factor(ba_survey.x)
                            )
       ) +
  ggtitle("Eating out in the UK \n % of episodes per halfhour on weekdays") +
  geom_line() + 
  scale_colour_grey(start = 0.8, end = 0.3, guide = guide_legend(reverse=TRUE)) + 
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
# could add confints to this but...
```

NB: eating out could include travelling.

## Dinner
		- Contemporary : timing, location, participants, seasons, who cooks
		- What changed in history -> energy implications
		- What varies between regions -> energy implications

## Sunday lunch
		- Contemporary : timing, location, participants, seasons, who cooks
		- What changed in history -> energy implications
		- What varies between regions -> energy implications



 
# Discussion
Draw together the threads of the results to discuss:

 * Main eating daily structure and synchronisation: giving time
 * Energy demand location: home, tertiary, industry
 * Employment, gender roles: how other practices change and constrain
 
# Acknowledgements
This work was funded by RCUK through the End User Energy Demand Centres Programme via the "DEMAND: Dynamics of Energy, Mobility and Demand" Centre:

 * http://www.demand.ac.uk 
 * http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K011723/1
 
# Statistical annexes (if needed)
## MTUS UK sample

MTUS activity codes collected per year.

```{r ukCodesTable}
# kable breaks on non-char code in one of the labels
table(mtusUKEpisodes_DT$main, mtusUKEpisodes_DT$ba_survey)
```

MTUS episodes per month by year

```{r ukEpisodesPerMonthTable}

kable(caption="UK episodes per month by survey",
  table(mtusUKEpisodes_DT$r_month, mtusUKEpisodes_DT$ba_survey)
)

```

MTUS episodes per season by year
```{r ukEpisodesPerSeasonTable}

kable(caption="UK episodes per season by survey",
  table(mtusUKEpisodes_DT$season, mtusUKEpisodes_DT$ba_survey)
)

```


MTUS episode locations per year

```{r ukLocationTable}

kable(caption="UK episodes per location (original) by survey",
  table(mtusUKEpisodes_DT$eloc, mtusUKEpisodes_DT$ba_survey)
)

```


## Testing methods to analyse temporal distributions of cooking & eating episodes
In order to control for the potentially different levels of reporting due to the different diary slot durations, we could also calculate an indicator which is 1 if at least one epsiode in a
given half hour is reported to be the activity of interest and 0 otherwise. In the case of the 1974 data where the diary slot duration was 30 minutes there
will be no difference. However in the case of the other diaries where data was collected in slots of 15 minutes (1983, 1987) or 10 minutes (2000/1,
2005) duration, this will have the effect of increasing the apparent rate as the denominator is no longer the sum of all episodes in the half hour but the
(lower) number of half hours.

The tables below show the distribution of these indicators across years.

```{r ukHHIndicatorTable}
kable(caption = "Cooking: Half hour indicator summaries (unweighted)",
  mtusUKHalfhourIndicator_DT[,
                    .(
                      "Cooking (mean n episodes per halfhour)" = round(mean(n_main_cook_eps), 2),
                      "Cooking (max episodes per hh)" = max(n_main_cook_eps),
                      "Cooking (% 'at least 1')" = round(mean(any_cook_m)*100,2)
                    ),
                    by = .(ba_survey)
                    ]
)
  kable(caption = "Eating: Half hour indicator summaries (unweighted)",
  mtusUKHalfhourIndicator_DT[,
                    .(
                      "Eating (mean n episodes per halfhour)" = round(mean(n_main_eat_eps),2),
                      "Eating (max episodes per halfhour)" = max(n_main_eat_eps),
                      "Eating (% 'at least 1')" = round(mean(any_eat_m)*100,2)
                    ),
                    by = .(ba_survey)
                    ]
)
```

We would expect there to be a maximum count of 1 in 1974 (the diary slots were 30 minutes long) but higher in the later years (diary slots are shorter). There appear to be some half hours with a lot of episode 'churn' - where the maximum is greater than 4. The following stem and leaf plots show the frequency of multiple episodes of cooking or eating per half hour.

Cooking:
```{r testNumberCookEpisodesHH}
stem(mtusUKHalfhourIndicator_DT$n_main_cook_eps)
```

Eating:
```{r testNumberEatEpisodesHH}
stem(mtusUKHalfhourIndicator_DT$n_main_eat_eps)
```

The stem plots suggest that these are extremely rare events and so can be discounted as affecting the indicator unduly.

In the rest of this section we explore the two different approaches to comparing temporal distirbutions. The first graph in each section simply shows the percentage of episodes in a given half hour that were reported as being the activity of interest.

This second graphs repeat the above analysis but instead uses the 'any in the half hour' indicator. In theory this should control for any affects of the shorter diary slots in the more recent diaries but it will, of course, treat (e.g.) 1 or 3 episodes within a half hour as equivalent.

### Cooking 
The following graph compares the results of these two methods for cooking.

```{r compareUKCookingHalfhour2005}
# construct a table of % cooking by time of episode start & ba_survey

cookeps <- mtusUKEpisodes_DT[,
                      .(
                      cook_eps_pc = round(mean(is_cooking_m)*100, 2)
                    ),
                    by = .(survey,st_halfhour)
                    ]
cookhh <- mtusUKHalfhourIndicator_DT[,
                      .(
                      cook_any_pc = round(mean(any_cook_m)*100, 2)
                    ),
                    by = .(survey,st_halfhour)
                    ]
# ba_survey pools 1983/4 and 1987
# add r_wday if you want weekdays 
ggplot(cookeps) +

  ggtitle("Comparison of methods: Cooking (Main act)") +
  geom_point(aes(x = st_halfhour, y = cook_eps_pc, 
                 col = "% episodes in the halfhour which are cooking")) +
  geom_point(aes(x = st_halfhour, y = cookhh$cook_any_pc, 
                 col = "% halfhours where at least 1 episode is cooking")) +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  facet_grid(survey ~ .) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
```

As we can see (as expected) that the 'at least 1 in a given half hour' matches to the % episodes per half hour in 1974 (1/2 hour diary slots), is higher in the morning in 1983/1987 (15 minute slots), similar in 1995 (15 minute slots) and higher in the mornings in 2000 & 2005 (10 minute slots). The indicator does not appear to unduly affect the observed patterns although it may over-emphasise cooking done in shorter durations such as in the early morning. This may lead us to conclude that 'more' cooking is being done in the morning which is not the case since this indicator cannot measure 'levels' of an activity.

### Eating
And now we do the same for eating.

```{r compareUKEatingHalfhour2005}
# construct a table of % cooking by time of episode start & ba_survey

eateps <- mtusUKEpisodes_DT[,
                      .(
                      eat_eps_pc = round(mean(is_eating_m)*100, 2)
                    ),
                    by = .(survey,st_halfhour)
                    ]
eathh <- mtusUKHalfhourIndicator_DT[,
                      .(
                      eat_any_pc = round(mean(any_eat_m)*100, 2)
                    ),
                    by = .(survey,st_halfhour)
                    ]
# ba_survey pools 1983/4 and 1987
# add r_wday if you want weekdays 
ggplot(eateps) +

  ggtitle("Comparison of methods: Eating") +
  geom_point(aes(x = st_halfhour, y = eat_eps_pc, 
                 col = "% episodes in the halfhour which are eating")) +
  geom_point(aes(x = st_halfhour, y = eathh$eat_any_pc, 
                 col = "% halfhours where at least 1 episode is eating")) +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  labs(x = "Time",
       y = "%"
  ) +
  facet_grid(survey ~ .) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(strip.text.y = element_text(size = 8, colour = "red", angle = 0))
```

As for cooking, the 'at least once in a given half hour' indicator records slightly higher values than the % episodes indicator from 1983 onwards (but not 1995) and especially in the morning. The same cautions therefore apply.

***
__Meta:__
Analysis completed in: `r round(Sys.time() - starttime, 3)` seconds using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com).

***
__Footnotes:__

# References